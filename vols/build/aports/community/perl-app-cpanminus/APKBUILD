# Automatically generated by apkbuild-cpan, template 3
# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: rubicon <rubicon@mailo.com>
pkgname=perl-app-cpanminus
#_pkgreal is used by apkbuild-cpan to find modules at MetaCpan
_pkgreal=App-cpanminus
pkgver=1.7046
pkgrel=0
pkgdesc="Get, unpack, build and install modules from CPAN"
url="https://metacpan.org/release/App-cpanminus/"
arch="noarch"
license="GPL-1.0-or-later OR Artistic-1.0-Perl"
depends="perl ssl_client ca-certificates-bundle"
options="net"	# needed to ensure cpanminus is able to access CPAN
subpackages="$pkgname-doc"
source="https://cpan.metacpan.org/authors/id/M/MI/MIYAGAWA/App-cpanminus-$pkgver.tar.gz
	use-https-mirrors.patch
	busybox-wget-compat.patch
	"
builddir="$srcdir/$_pkgreal-$pkgver"
_blibdir="$builddir/blib"

# secfixes:
#   1.7045-r0:
#     - CVE-2020-16154

build() {
	export CFLAGS=$(perl -MConfig -E 'say $Config{ccflags}')
	# cpanm is the same as fatscript.pm, except for additional
	# processing by perlstrip. This removes whitespace and
	# comments, "minifying" the code. Unfortunately, cpanm
	# cannot be rebuilt by simply running perlstrip on a patched
	# fatscript.pm. So, we remove the "minified" code from cpanm,
	# and instead make it call into the patched fatscript.pm.
	# This line using sed should be stable, because the comments
	# it matches for deletion are script-generated, and any
	# other problems will be detected in check().
	sed -i -e '/^# DO NOT EDIT/,/# END OF FATPACK CODE/ d' \
		-re 's/^(use App::cpanminus::)(script)/\1fat\2/' \
		"$builddir"/bin/cpanm
	PERL_MM_USE_DEFAULT=1 perl -I. Makefile.PL INSTALLDIRS=vendor
	make
}

check() {
	export CFLAGS=$(perl -MConfig -E 'say $Config{ccflags}')
	make test
	# test if cpanm can access www.cpan.org
	perl -I "$_blibdir"/lib \
		"$_blibdir"/script/cpanm \
		--showdeps App::cpanminus
}

package() {
	make DESTDIR="$pkgdir" install
	find "$pkgdir" \( -name perllocal.pod -o -name .packlist \) -delete
}

sha512sums="
ced5f264979eb50cc33ac566c0242998c9b9c158ba435b9a180810f58eaa0b28d0de70312ade10df0ee3808369423f7baa029f2be740461d20a695e5e24d0d9b  App-cpanminus-1.7046.tar.gz
b775836197d4ae2244a60ff3f2ba6cf2aa3217cc71686d20fae0eff6f2dfc222f4cfb73a97ffcaf5756c52312104130dc9e3837f1cf5d1b711d81b0bd7dd41ca  use-https-mirrors.patch
cd5aecb7f834dfef705f11fa8499b9257e299de862e1ef62d040da6b436191d7d42e48303113c118fb5604975a0ece950426c69382f1205328e9d28d08ac31e9  busybox-wget-compat.patch
"
